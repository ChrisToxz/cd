#!/command/with-contenv bash

# Exit on error
set -e

echo "---"
echo "Setting up Slipstream"
echo "---"

if [ ! -f /.env ]; then
    echo "Environment file not found, creating..."
    s6-setuidgid webuser cp $WEBUSER_HOME/.env.example $WEBUSER_HOME/.env
    echo "âœ…  Environment file created."
else
    echo "âœ…  Environment file exists."
fi

# Check for app key
if grep -E "APP_KEY=[0-9A-Za-z:+\/=]{1,}" $WEBUSER_HOME/.env > /dev/null; then
    echo "âœ…  App key exists"
else
    echo "â³  Generating app key..."
    s6-setuidgid webuser php $WEBUSER_HOME/artisan key:generate --no-ansi -q
    echo "âœ…  App key generated."
fi

# Check to see if an Artisan file exists and assume it means Laravel is configured.
if [ -f $WEBUSER_HOME/artisan ] && [ ${AUTORUN_ENABLED:="true"} == "true" ]; then
        echo "ğŸƒâ€â™‚ï¸ Checking for Laravel automations..."

        ############################################################################
        # Automated database migrations
        ############################################################################
        if [ ${AUTORUN_LARAVEL_MIGRATION:="false"} == "true" ]; then
            echo "ğŸš€ Running migrations..."
            s6-setuidgid webuser php $WEBUSER_HOME/artisan migrate --force --isolated
        fi

        ############################################################################
        # Automated storage linking
        ############################################################################
        if [ ${AUTORUN_LARAVEL_STORAGE_LINK:="true"} == "true" ]; then
            if [ -d $WEBUSER_HOME/public/storage ]; then
                echo "âœ… Storage already linked..."
            else
                echo "ğŸ” Linking the storage..."
                s6-setuidgid webuser php $WEBUSER_HOME/artisan storage:link
            fi
        fi
else
    echo "ğŸ‘‰ Skipping Laravel automations because we could not detect a Laravel install or it was specifically disabled..."
fi

echo "ğŸ•› Starting queue"
# TODO: Change to worker
#s6-setuidgid webuser php $WEBUSER_HOME/artisan queue:listen --tries=3 &

echo "âœ… Slipstream started."
echo ""

exit 0
